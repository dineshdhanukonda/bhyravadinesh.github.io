// ðŸ”¥ TradeWithBhyrava - All-in-One Live Backend
const express = require('express');
const axios = require('axios');
const nodemailer = require('nodemailer');
const TelegramBot = require('node-telegram-bot-api');

const app = express();
const PORT = process.env.PORT || 3000;

// âœ… REPLACE WITH YOUR SECRETS IF .env ISN'T USED
const TELEGRAM_BOT_TOKEN = '7372807989:AAFROF1UzElkM1B8k2JgLM4ROIxtcOzkThY';
const TELEGRAM_CHAT_ID = '7372807989';
const MAIL_ID = 'bhyravadinesh@gmail.com';
const MAIL_PASS = 'W6NCSDBCOERNUFGDQHLCC2FR3E';

const bot = new TelegramBot(TELEGRAM_BOT_TOKEN, { polling: false });

const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: MAIL_ID,
    pass: MAIL_PASS
  }
});

// âœ… API: Fetch Option Chain from NSE
app.get('/option-chain', async (req, res) => {
  try {
    const response = await axios.get(
      'https://www.nseindia.com/api/option-chain-indices?symbol=NIFTY',
      {
        headers: {
          'User-Agent': 'Mozilla/5.0',
          'Referer': 'https://www.nseindia.com/option-chain'
        }
      }
    );
    const top10 = response.data.records.data.slice(0, 10);
    res.json({ status: 'ok', data: top10 });
  } catch (error) {
    res.status(500).json({ status: 'error', message: error.message });
  }
});

// âœ… API: Send Alert to Telegram & Email
app.get('/send-alert', async (req, res) => {
  const alertMessage = 'ðŸ“¢ Bhyrava Alert: Check NIFTY movement now!';

  try {
    await bot.sendMessage(TELEGRAM_CHAT_ID, alertMessage);
    await transporter.sendMail({
      from: MAIL_ID,
      to: MAIL_ID,
      subject: 'ðŸ“ˆ Trade Alert - Bhyrava',
      text: alertMessage
    });

    res.json({ status: 'Alert sent to Telegram and Email!' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.get('/', (req, res) => {
  res.send('âœ… TradeWithBhyrava backend is running...');
});

app.listen(PORT, () => {
  console.log(`ðŸš€ Server running at http://localhost:${PORT}`);
});
